name: Smoke Tests

on:
  workflow_call:
  push:
    branches: [ main, master, develop, dev ]
  pull_request:
    branches: [ main, master, develop, dev ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip setuptools wheel
    
    - name: Install core dependencies
      run: |
        pip install -r requirements-core.txt
    
    - name: Install test dependencies
      run: |
        pip install -r requirements-test.txt
    
    - name: Verify version synchronization
      run: |
        python scripts/sync_version.py
        VERSION_FROM_MODULE=$(python -c "from version import get_version; print(get_version())")
        VERSION_FROM_TOML=$(python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")
        if [ "$VERSION_FROM_MODULE" != "$VERSION_FROM_TOML" ]; then
          echo "❌ Version mismatch: module=$VERSION_FROM_MODULE, toml=$VERSION_FROM_TOML"
          exit 1
        fi
        echo "✅ Versions synchronized: $VERSION_FROM_MODULE"
    
    - name: Run smoke tests
      run: |
        pytest tests/test_smoke.py \
          -v \
          -m smoke \
          --tb=short \
          --strict-markers \
          --maxfail=5

