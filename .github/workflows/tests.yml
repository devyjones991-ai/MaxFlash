name: Tests

on:
  workflow_call:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          wget \
          curl
    
    - name: Try to install TA-Lib (optional)
      continue-on-error: true
      run: |
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz || exit 0
        tar -xzf ta-lib-0.4.0-src.tar.gz || exit 0
        cd ta-lib/ || exit 0
        ./configure --prefix=/usr || exit 0
        make || exit 0
        sudo make install || exit 0
        cd .. || exit 0
        pip install TA-Lib || exit 0
        echo "TA-Lib installed successfully" || echo "TA-Lib optional - skipped"
    
    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip setuptools wheel
    
    - name: Install core dependencies
      run: |
        pip install -r requirements-core.txt
    
    - name: Install test dependencies
      run: |
        pip install -r requirements-test.txt
    
    - name: Install optional dependencies (with fallback)
      continue-on-error: true
      run: |
        pip install scipy>=1.10.0 || echo "SciPy optional - continuing"
        pip install matplotlib>=3.7.0 || echo "Matplotlib optional - continuing"
        pip install plotly>=5.14.0 || echo "Plotly optional - continuing"
        pip install dash>=2.14.0 || echo "Dash optional - continuing"
        pip install discord.py>=2.3.0 || echo "Discord.py optional - continuing"
    
    - name: Verify imports
      run: |
        python -c "import pandas; import numpy; print('âœ“ Core imports OK')"
        python -c "import ccxt; print('âœ“ CCXT OK')" || echo "âš  CCXT optional"
        python -c "import scipy; print('âœ“ SciPy OK')" || echo "âš  SciPy optional"
        python -c "import pytest; print('âœ“ Pytest OK')"
    
    - name: Run tests with pytest
      id: pytest
      run: |
        set -e  # Exit on error, but we'll catch it
        
        # Run pytest and capture exit code
        pytest tests/ \
          -v \
          --tb=short \
          --cov=indicators \
          --cov=utils \
          --cov=strategies \
          --cov-report=xml \
          --cov-report=term-missing \
          --maxfail=10 \
          --continue-on-collection-errors \
          -W ignore::DeprecationWarning \
          -W ignore::PendingDeprecationWarning \
          --junit-xml=junit.xml \
          --strict-markers \
          ; pytest_exit=$?
        
        # Always create junit.xml even if tests fail
        if [ ! -f junit.xml ]; then
          echo '<?xml version="1.0"?><testsuite name="pytest" tests="0" failures="0" errors="0" skipped="0"></testsuite>' > junit.xml
        fi
        
        # Set output
        if [ ${pytest_exit} -eq 0 ]; then
          echo "exit_code=0" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "exit_code=1" >> $GITHUB_OUTPUT
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
        
        exit 0  # Don't fail this step, check in next step
    
    - name: Check test results
      if: always()
      run: |
        echo "ðŸ“Š Analyzing test results..."
        echo "================================"
        
        # Check if pytest step succeeded
        if [ "${{ steps.pytest.outcome }}" == "failure" ] || [ "${{ steps.pytest.outputs.exit_code }}" == "1" ]; then
          echo "âŒ Pytest step failed"
          if [ -f junit.xml ]; then
            echo "\nFailed tests:"
            grep -E 'status="failed"|name=' junit.xml | grep -A 1 'status="failed"' | head -20 || true
          fi
          exit 1
        fi
        
        # Parse junit.xml if it exists
        if [ -f junit.xml ]; then
          passed=$(grep -c 'status="passed"' junit.xml 2>/dev/null || echo "0")
          failed=$(grep -c 'status="failed"' junit.xml 2>/dev/null || echo "0")
          skipped=$(grep -c 'status="skipped"' junit.xml 2>/dev/null || echo "0")
          errors=$(grep -c 'status="error"' junit.xml 2>/dev/null || echo "0")
          
          echo "âœ… Passed: $passed"
          echo "âŒ Failed: $failed"
          echo "âš ï¸  Errors: $errors"
          echo "â­ï¸  Skipped: $skipped"
          echo "================================"
          
          total=$((passed + failed + errors))
          if [ "$total" -eq 0 ]; then
            echo "âš ï¸  No tests found or executed"
            exit 1
          fi
          
          if [ "$failed" -gt 0 ] || [ "$errors" -gt 0 ]; then
            echo "âŒ Some tests failed or had errors"
            if [ "$failed" -gt 0 ]; then
              echo "\nFailed test details:"
              grep -B 2 'status="failed"' junit.xml | grep 'name=' | head -10 || true
            fi
            exit 1
          else
            echo "âœ… All tests passed!"
            exit 0
          fi
        else
          echo "âš ï¸  No junit.xml file found"
          echo "Running quick verification..."
          python -c "
import sys
sys.path.insert(0, '.')
try:
    from tests.conftest import sample_dataframe
    import pandas as pd
    import numpy as np
    df = sample_dataframe()
    assert len(df) > 0
    print('âœ“ Basic test setup verified')
except Exception as e:
    print(f'âœ— Test setup error: {e}')
    sys.exit(1)
" || exit 1
        fi
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit.xml
          coverage.xml
        if-no-files-found: ignore
    
    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.10' && always()
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
